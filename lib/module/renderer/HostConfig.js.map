{"version":3,"sources":["HostConfig.ts"],"names":["createNode","isSelector","isValue","mapKeys","shallowEq","DEBUG","debug","console","log","appendNode","parent","child","addChild","removeNode","removeChild","insertBefore","before","insertChildBefore","skHostConfig","now","Date","supportsMutation","isPrimaryRenderer","supportsPersistence","supportsHydration","scheduleTimeout","setTimeout","cancelTimeout","clearTimeout","noTimeout","appendChildToContainer","container","root","appendChild","getRootHostContext","_rootContainerInstance","getChildHostContext","_parentHostContext","_type","shouldSetTextContent","_props","createTextInstance","_text","_hostContext","_internalInstanceHandle","Error","createInstance","type","pristineProps","props","node","materialize","depMgr","subscribeNode","appendInitialChild","parentInstance","finalizeInitialChildren","commitMount","prepareForCommit","_containerInfo","resetAfterCommit","redraw","getPublicInstance","prepareUpdate","_instance","oldProps","newProps","rootContainerInstance","propsAreEqual","commitUpdate","instance","updatePayload","prevProps","nextProps","_internalHandle","unsubscribeNode","setProps","commitTextUpdate","_textInstance","_oldText","_newText","clearContainer","children","forEach","preparePortalMount","removeChildFromContainer","insertInContainerBefore","result","key","prop","current","selector","value"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/*global NodeJS*/\nimport type { HostConfig } from \"react-reconciler\";\n\nimport type { NodeType, Node } from \"../dom/types\";\nimport type { SkiaValue } from \"../values\";\n\nimport type { Container } from \"./Container\";\nimport { createNode } from \"./HostComponents\";\nimport type { AnimatedProps } from \"./processors\";\nimport { isSelector, isValue } from \"./processors\";\nimport { mapKeys, shallowEq } from \"./typeddash\";\n\nconst DEBUG = false;\nexport const debug = (...args: Parameters<typeof console.log>) => {\n  if (DEBUG) {\n    console.log(...args);\n  }\n};\n\ntype Instance = Node<unknown>;\n\ntype Props = any;\ntype TextInstance = Node<unknown>;\ntype SuspenseInstance = Instance;\ntype HydratableInstance = Instance;\ntype PublicInstance = Instance;\ntype HostContext = null;\ntype UpdatePayload = Container;\ntype ChildSet = unknown;\ntype TimeoutHandle = NodeJS.Timeout;\ntype NoTimeout = -1;\n\ntype SkiaHostConfig = HostConfig<\n  NodeType,\n  Props,\n  Container,\n  Instance,\n  TextInstance,\n  SuspenseInstance,\n  HydratableInstance,\n  PublicInstance,\n  HostContext,\n  UpdatePayload,\n  ChildSet,\n  TimeoutHandle,\n  NoTimeout\n>;\n\nconst appendNode = (parent: Node<unknown>, child: Node<unknown>) => {\n  parent.addChild(child);\n};\n\nconst removeNode = (parent: Node<unknown>, child: Node<unknown>) => {\n  return parent.removeChild(child);\n};\n\nconst insertBefore = (\n  parent: Node<unknown>,\n  child: Node<unknown>,\n  before: Node<unknown>\n) => {\n  parent.insertChildBefore(child, before);\n};\n\nexport const skHostConfig: SkiaHostConfig = {\n  /**\n   * This function is used by the reconciler in order to calculate current time for prioritising work.\n   */\n  now: Date.now,\n\n  supportsMutation: true,\n  isPrimaryRenderer: false,\n  supportsPersistence: false,\n  supportsHydration: false,\n  //supportsMicrotask: true,\n\n  scheduleTimeout: setTimeout,\n  cancelTimeout: clearTimeout,\n  noTimeout: -1,\n\n  appendChildToContainer(container, child) {\n    debug(\"appendChildToContainer\", container, child);\n    appendNode(container.root, child);\n  },\n\n  appendChild(parent, child) {\n    debug(\"appendChild\", parent, child);\n    appendNode(parent, child);\n  },\n\n  getRootHostContext: (_rootContainerInstance: Container) => {\n    debug(\"getRootHostContext\");\n    return null;\n  },\n\n  getChildHostContext(_parentHostContext, _type, _rootContainerInstance) {\n    debug(\"getChildHostContext\");\n    return null;\n  },\n\n  shouldSetTextContent(_type, _props) {\n    return false;\n  },\n\n  createTextInstance(\n    _text,\n    _rootContainerInstance,\n    _hostContext,\n    _internalInstanceHandle\n  ) {\n    debug(\"createTextInstance\");\n    // return SpanNode({}, text) as SkNode;\n    throw new Error(\"Text nodes are not supported yet\");\n  },\n\n  createInstance(\n    type,\n    pristineProps,\n    container,\n    _hostContext,\n    _internalInstanceHandle\n  ) {\n    debug(\"createInstance\", type);\n    const props = { ...pristineProps };\n    const node = createNode(container, type, materialize(props));\n    container.depMgr.subscribeNode(node, props);\n    return node;\n  },\n\n  appendInitialChild(parentInstance, child) {\n    debug(\"appendInitialChild\");\n    appendNode(parentInstance, child);\n  },\n\n  finalizeInitialChildren(\n    parentInstance,\n    _type,\n    _props,\n    _rootContainerInstance,\n    _hostContext\n  ) {\n    debug(\"finalizeInitialChildren\", parentInstance);\n    return false;\n  },\n\n  commitMount() {\n    // if finalizeInitialChildren = true\n    debug(\"commitMount\");\n  },\n\n  prepareForCommit(_containerInfo) {\n    debug(\"prepareForCommit\");\n    return null;\n  },\n\n  resetAfterCommit(container) {\n    debug(\"resetAfterCommit\");\n    container.redraw();\n  },\n\n  getPublicInstance(node: Instance) {\n    debug(\"getPublicInstance\");\n    return node;\n  },\n\n  prepareUpdate: (\n    _instance,\n    type,\n    oldProps,\n    newProps,\n    rootContainerInstance,\n    _hostContext\n  ) => {\n    debug(\"prepareUpdate\");\n    const propsAreEqual = shallowEq(oldProps, newProps);\n    if (propsAreEqual) {\n      return null;\n    }\n    debug(\"update \", type);\n    return rootContainerInstance;\n  },\n\n  commitUpdate(\n    instance,\n    updatePayload,\n    type,\n    prevProps,\n    nextProps,\n    _internalHandle\n  ) {\n    debug(\"commitUpdate: \", type);\n    if (shallowEq(prevProps, nextProps)) {\n      return;\n    }\n    const props = { ...nextProps };\n    updatePayload.depMgr.unsubscribeNode(instance);\n    instance.setProps(materialize(props));\n    updatePayload.depMgr.subscribeNode(instance, props);\n  },\n\n  commitTextUpdate: (\n    _textInstance: TextInstance,\n    _oldText: string,\n    _newText: string\n  ) => {\n    //  textInstance.instance = newText;\n  },\n\n  clearContainer: (container) => {\n    debug(\"clearContainer\");\n    container.root.children().forEach((child) => {\n      container.root.removeChild(child);\n    });\n  },\n\n  preparePortalMount: () => {\n    debug(\"preparePortalMount\");\n  },\n\n  removeChild: (parent, child) => {\n    removeNode(parent, child);\n  },\n\n  removeChildFromContainer: (container, child) => {\n    removeNode(container.root, child);\n  },\n\n  insertInContainerBefore: (container, child, before) => {\n    insertBefore(container.root, child, before);\n  },\n\n  insertBefore: (parent, child, before) => {\n    insertBefore(parent, child, before);\n  },\n};\n\nconst materialize = <P>(props: AnimatedProps<P>) => {\n  const result = { ...props };\n  mapKeys(props).forEach((key) => {\n    const prop = props[key];\n    if (isValue(prop)) {\n      result[key] = (prop as SkiaValue<P[typeof key]>).current;\n    } else if (isSelector(prop)) {\n      result[key] = prop.selector(prop.value.current) as P[typeof key];\n    }\n  });\n\n  return result as any;\n};\n"]}